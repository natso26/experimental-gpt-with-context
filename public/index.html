<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Inventio</title>
    <style>
        html {
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: monospace;
            font-size: 16px;
            margin: 15px 0 0 14px;
            color: #262626;
        }

        .footnote {
            font-size: 14px;
            text-align: right;
            width: calc(84% + 22px);
            margin: 4px 0 0 0;
            color: #bbb;
        }

        .text-box {
            font-family: monospace;
            font-size: 15px;
            width: 84%;
            border: 1px solid #bbb;
            border-radius: 8px;
            padding: 10px;
        }

        .buttons-panel {
            display: flex;
            flex-direction: row;
            width: calc(84% + 22px);
            justify-content: space-between;
            align-items: center;
            margin: 4px 0 0 0;
        }

        .button {
            font-family: monospace;
            font-size: 14px;
            width: 108px;
            border: none;
            border-radius: 16px;
            padding: 8px;
            background-color: aliceblue;
        }

        .button-recolor {
            background-color: orange;
        }

        .button-shaped-link {
            border-radius: 16px;
        }
    </style>
</head>
<body>
<label for="session-id" id="session-id-label">Session ID</label>
<div>
    <textarea class="text-box" id="session-id" maxlength="36" rows="1"></textarea>
</div>
<br>
<label for="query" id="query-label">Query</label>
<div>
    <textarea class="text-box" id="query" rows="4"></textarea>
</div>
<div class="buttons-panel">
    <button class="button" id="submit">Submit</button>
    <a class="button-shaped-link" href="/history" id="to-history">
        <button class="button button-recolor">History</button>
    </a>
</div>
<br><br>
<label for="reply" id="reply-label">Reply</label>
<div>
    <textarea class="text-box" disabled id="reply" rows="16"></textarea>
</div>
<div class="footnote"><span id="note"></span></div>

<script>
    const sessionIdLabel = document.getElementById('session-id-label');
    const sessionIdBox = document.getElementById('session-id');
    const queryLabel = document.getElementById('query-label');
    const queryBox = document.getElementById('query');
    const submitButton = document.getElementById('submit');
    const toHistoryLink = document.getElementById('to-history');
    const replyLabel = document.getElementById('reply-label');
    const replyBox = document.getElementById('reply');
    const noteArea = document.getElementById('note');
    const uuidv4 = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = Math.random() * 16 | 0;
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
    const updateUrls = () => {
        const sessionId = sessionIdBox.value.trim();
        toHistoryLink.href = `/history?userId=${userId}&sessionId=${sessionId}`;
        const url = new URL(window.location.href);
        const p = url.searchParams;
        p.set('sessionId', sessionId);
        window.history.pushState({}, '', url);
    };
    const p = new URL(window.location.href).searchParams;
    const userId = p.get('userId') || '';
    sessionIdBox.value = p.get('sessionId') || uuidv4();
    updateUrls();
    sessionIdBox.addEventListener('change', updateUrls);
    const addCopyListener = (el, val, copyMsg) => {
        let cancel = null;
        el.addEventListener('click', () => {
            if (cancel) return;
            navigator.clipboard.writeText(val());
            const v = el.innerText;
            el.innerText = copyMsg;
            cancel = () => {
                if (!cancel) return;
                el.innerText = v;
                cancel = null;
            };
            setTimeout(() => cancel?.(), 750);
        });
        return () => cancel?.();
    };
    const cancelSessionIdCopy = addCopyListener(sessionIdLabel, () => sessionIdBox.value, '(session ID copied)');
    const cancelQueryCopy = addCopyListener(queryLabel, () => queryBox.value, '(query copied)');
    const cancelReplyCopy = addCopyListener(replyLabel, () => replyBox.value, '(reply copied)');
    let debugResp = null;
    const cancelNoteCopy = addCopyListener(noteArea, () => JSON.stringify(debugResp, null, 2), '(response copied)');
    const cancelCopies = () => {
        cancelSessionIdCopy();
        cancelQueryCopy();
        cancelReplyCopy();
        cancelNoteCopy();
    };
    const onResp = (debug, reply, note) => {
        console.log(debug);
        debugResp = debug;
        cancelCopies();
        replyBox.value = reply;
        noteArea.innerText = note;
    };
    submitButton.addEventListener('click', async () => {
        const sessionId = sessionIdBox.value.trim();
        const query = queryBox.value;
        sessionIdBox.disabled = true;
        queryBox.disabled = true;
        submitButton.disabled = true;
        const start = Date.now();
        const formattedElapsed = () => `${Math.round((Date.now() - start) / 1000)}s`;
        try {
            const resp = await fetch('/api/query', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({userId, sessionId, query}),
            });
            if (!resp.ok) {
                const error = await resp.json();
                onResp({error}, JSON.stringify(error, null, 2), `${formattedElapsed()} (failed)`);
            } else {
                let partialReply = '';
                let progress = '';
                const reader = resp.body.getReader();
                const processChunk = (chunk) => {
                    const data = JSON.parse(chunk);
                    const {state, data: data_} = data;
                    switch (state) {
                        case 'keepalive':
                            progress += '.';
                            onResp({data}, partialReply || progress, formattedElapsed());
                            return false;
                        case 'partial':
                            switch (data_.event) {
                                case 'task':
                                    partialReply = '';
                                    progress += `\ndone â€“ ${data_.kind}\n`
                                    onResp({data}, progress, formattedElapsed());
                                    break;
                                case 'reply':
                                    if (!data_.reply) partialReply += data_.diff || '';
                                    else partialReply = data_.reply;
                                    onResp({data}, partialReply, formattedElapsed());
                                    break;
                            }
                            return false;
                        case 'success':
                            const {reply} = data_;
                            onResp({data}, reply, `${reply.length} chars, ${formattedElapsed()}`);
                            return true;
                        case 'error':
                            onResp({data}, JSON.stringify(data_, null, 2), `${formattedElapsed()} (failed)`);
                            return true;
                    }
                }
                let currChunk = null;
                let tempPrefix = '';
                readLoop: while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    const lines = new TextDecoder().decode(value).split('\n');
                    for (const line of lines) {
                        if (!line) {
                            if (currChunk !== null) {
                                if (processChunk(currChunk)) break readLoop;
                                currChunk = null;
                            }
                        } else if (currChunk === null) {
                            const line_ = tempPrefix + line;
                            if (line_.length < 6) tempPrefix = line_;
                            else {
                                tempPrefix = '';
                                if (!line_.startsWith('data: ')) console.log('invalid line', line);
                                else currChunk = line_.slice(6);
                            }
                        } else currChunk += line;
                    }
                }
            }
        } catch (e) {
            const ex = explainError(e);
            onResp({e: ex}, ex.error, `${formattedElapsed()} (failed)`);
        }
        sessionIdBox.disabled = false;
        queryBox.disabled = false;
        submitButton.disabled = false;
    });
    const explainError = (e) => ({error: `${e.name || ''}: ${e.message || ''}`, stack: e.stack || ''});
</script>
</body>
</html>
