<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Experimental GPT</title>
    <style>
        body {
            font-family: monospace;
            font-size: 16px;
            margin: 15px 0 0 14px;
            color: #262626;
        }

        .footnote {
            font-size: 14px;
            text-align: right;
            width: calc(84% + 22px);
            margin: 4px 0 0 0;
            color: #bbb;
        }

        .text-box {
            font-family: monospace;
            font-size: 15px;
            width: 84%;
            border: 1px solid #bbb;
            border-radius: 8px;
            padding: 10px;
        }

        .buttons-panel {
            display: flex;
            flex-direction: row;
            width: calc(84% + 22px);
            justify-content: space-between;
            align-items: center;
        }

        .button {
            font-family: monospace;
            font-size: 14px;
            width: 108px;
            border: none;
            border-radius: 16px;
            padding: 8px;
            margin: 4px 0 0 0;
            background-color: aliceblue;
        }

        .button-recolor {
            background-color: orange;
        }
    </style>
</head>
<body>
<label for="chat-id">Chat ID</label>
<div>
    <textarea class="text-box" id="chat-id" rows="1"></textarea>
</div>
<br>
<label for="query">Query</label>
<div>
    <textarea class="text-box" id="query" rows="4"></textarea>
</div>
<div class="buttons-panel">
    <button class="button" id="submit">Submit</button>
    <button class="button button-recolor" id="history">History</button>
</div>
<br><br>
<label for="reply">Reply</label>
<div>
    <textarea class="text-box" disabled id="reply" rows="16"></textarea>
</div>
<div class="footnote" id="note"></div>

<script>
    const chatIdBox = document.getElementById('chat-id');
    const queryBox = document.getElementById('query');
    const submitButton = document.getElementById('submit');
    const historyButton = document.getElementById('history');
    const replyBox = document.getElementById('reply');
    const noteArea = document.getElementById('note');
    const uuidv4 = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
    const updateUrl = () => {
        const chatId = chatIdBox.value.trim();
        const url = new URL(window.location.href);
        url.searchParams.set('chatId', chatId);
        window.history.pushState({}, '', url);
    };
    chatIdBox.value = new URL(window.location.href).searchParams.get('chatId') || uuidv4();
    updateUrl();
    chatIdBox.addEventListener('change', updateUrl);
    submitButton.addEventListener('click', async () => {
        const chatId = chatIdBox.value.trim();
        const query = queryBox.value;
        chatIdBox.disabled = true;
        queryBox.disabled = true;
        submitButton.disabled = true;
        const start = Date.now();
        try {
            const resp = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({chatId, query}),
            });
            const end = Date.now();
            if (!resp.ok) {
                const error = await resp.json();
                console.log({error});
                replyBox.value = JSON.stringify(error, null, 2);
                noteArea.innerText = `${Math.round((end - start) / 1000)}s (failed)`;
            } else {
                const data = await resp.json();
                console.log({data});
                replyBox.value = data.reply;
                noteArea.innerText = `${Math.round((end - start) / 1000)}s`;
            }
        } catch (e) {
            const end = Date.now();
            console.log({e});
            replyBox.value = e.message || 'There was an error fetching the response.';
            noteArea.innerText = `${Math.round((end - start) / 1000)}s (failed)`;
        }
        chatIdBox.disabled = false;
        queryBox.disabled = false;
        submitButton.disabled = false;
    });
    historyButton.addEventListener('click', () => {
        const chatId = chatIdBox.value.trim();
        window.location.href = `/history?chatId=${chatId}`;
    });
</script>
</body>
</html>